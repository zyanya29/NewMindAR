<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      body { margin: 0; overflow: hidden; }
      canvas, .a-canvas { touch-action: manipulation; }

      /* Overlay de instrucción (UI) */
      #hint {
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: #fff;
        padding: 8px 14px;
        border-radius: 9999px;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        font-size: 14px;
        letter-spacing: .2px;
        z-index: 9999;
        pointer-events: none;
        box-shadow: 0 4px 16px rgba(0,0,0,.25);
        transition: opacity .4s ease;
      }
      #hint.fade { opacity: 0; }

      /* Botón flotante Pausar/Reanudar */
      #toggleScanBtn {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10000;
        padding: 12px 18px;
        border: 0;
        border-radius: 9999px;
        font-size: 15px;
        font-weight: 600;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: #0ea5e9;
        color: white;
        box-shadow: 0 8px 24px rgba(0,0,0,.2);
        cursor: pointer;
        touch-action: manipulation;
      }
      #toggleScanBtn:disabled { opacity: .6; cursor: default; }
    </style>

    <script>
      // Obtiene el sistema de MindAR (imagen) desde la escena
      function getMindImageSystem() {
        const sceneEl = document.querySelector('a-scene');
        return sceneEl && sceneEl.systems && sceneEl.systems['mindar-image-system'];
      }

      // Estado local de pausa (independiente de implementación interna)
      let isPaused = false; // asumimos que empieza corriendo

      function setButtonLabel(btn) {
        btn.textContent = isPaused ? '▶️ Reanudar escaneo' : '⏸️ Pausar escaneo';
        btn.setAttribute('aria-pressed', String(isPaused));
        btn.setAttribute('aria-label', isPaused ? 'Reanudar escaneo' : 'Pausar escaneo');
      }

      function toggleScanning() {
        const btn = document.getElementById('toggleScanBtn');
        const hint = document.getElementById('hint');
        const arSystem = getMindImageSystem();
        if (!btn || !arSystem) return;

        btn.disabled = true;

        const hasPause = typeof arSystem.pause === 'function';
        const hasResume = typeof arSystem.resume === 'function';

        try {
          if (!isPaused) {
            // PAUSAR
            if (hasPause) {
              arSystem.pause();
            } else {
              // Fallback si no existe pause(): detenemos el sistema
              arSystem.stop();
            }
            isPaused = true;
          } else {
            // REANUDAR
            if (hasResume) {
              arSystem.resume();
            } else {
              // Fallback si no existe resume(): iniciamos de nuevo
              arSystem.start();
            }
            isPaused = false;
          }
        } catch (e) {
          // Si algo falla, intentamos el fallback stop/start directo
          try {
            if (!isPaused) {
              arSystem.stop();
              isPaused = true;
            } else {
              arSystem.start();
              isPaused = false;
            }
          } catch (err) {
            // último recurso: dejamos el botón utilizable
          }
        }

        // Actualiza UI
        setButtonLabel(btn);

        // Oculta el hint tras el primer uso
        if (hint && !hint.classList.contains('fade')) {
          hint.classList.add('fade');
          setTimeout(() => { hint.style.display = 'none'; }, 450);
        }

        // Rehabilita tras un pequeño retardo
        setTimeout(() => { btn.disabled = false; }, 300);
      }

      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('toggleScanBtn');
        setButtonLabel(btn);
        btn.disabled = true; // se habilita cuando MindAR esté listo

        // Habilita el botón cuando MindAR notifica que está listo
        const sceneEl = document.querySelector('a-scene');
        if (sceneEl) {
          sceneEl.addEventListener('arReady', () => {
            btn.disabled = false;
          });
          sceneEl.addEventListener('arError', () => {
            // Si hay error de cámara/permiso, no habilitamos el botón
          });
        }

        btn.addEventListener('click', toggleScanning);
      });
    </script>
  </head>
  <body>
    <!-- Texto de UI -->
    <div id="hint">Usa el botón para pausar o reanudar el escaneo de los marcadores</div>
    <!-- Botón global -->
    <button id="toggleScanBtn" aria-pressed="false" aria-label="Pausar escaneo">⏸️ Pausar escaneo</button>

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-assets>
        <!-- Rutas a tus modelos -->
        <a-asset-item id="clockModel" src="./clock.glb"></a-asset-item>
        <a-asset-item id="crownModel" src="./kings_crown.glb"></a-asset-item>
      </a-assets>

      <!-- Cámara simple -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target 0 -->
      <a-entity id="target0" mindar-image-target="targetIndex: 0">
        <a-gltf-model
          id="modelA"
          rotation="0 0 0"
          position="0 -0.25 0"
          scale="2.00 2.00 2.00"
          src="#crownModel"
          animation-mixer>
        </a-gltf-model>
      </a-entity>

      <!-- Target 1 -->
      <a-entity id="target1" mindar-image-target="targetIndex: 1">
        <a-gltf-model
          id="modelB"
          rotation="0 0 0"
          position="0 -0.25 0"
          scale="0.20 0.20 0.20"
          src="#clockModel"
          animation-mixer>
        </a-gltf-model>
      </a-entity>
    </a-scene>
  </body>
</html>


